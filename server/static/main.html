<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Single Image Object Detection</title>
        <style>
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                font-family: Arial, sans-serif;
            }
            #imageContainer {
                position: relative;
                width: 100%;
                max-width: 640px;
            }
            #image {
                width: 100%;
                height: auto;
            }
            #overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }
            #status {
                margin-top: 10px;
                font-size: 16px;
            }
            button,
            input[type="file"] {
                margin-top: 10px;
                padding: 10px 20px;
                font-size: 16px;
            }
        </style>
    </head>
    <body>
        <h1>Segmentador de Resistores e Faixas</h1>
        <input
            type="file"
            id="imageInput"
            accept="image/*"
            capture="environment"
        />
        <div id="imageContainer">
            <img id="image" src="" alt="Captured Image" style="display: none" />
            <canvas id="overlay"></canvas>
        </div>
        <p id="status">Pronto para tirar foto.</p>

        <script>
            // DOM elements
            const imageInput = document.getElementById("imageInput");
            const image = document.getElementById("image");
            const overlay = document.getElementById("overlay");
            const status = document.getElementById("status");
            const ctx = overlay.getContext("2d");

            const colorMap = {
                black_belt: "black",
                blue_belt: "blue",
                brown_belt: "brown",
                gold_belt: "gold",
                gray_belt: "gray",
                green_belt: "green",
                orange_belt: "orange",
                purple_belt: "purple",
                red_belt: "red",
                resistor: "#d2b48c",
                white_belt: "white",
                yellow_belt: "yellow",
            };

            // Set canvas size to match image
            function resizeCanvas() {
                overlay.width = image.width;
                overlay.height = image.height;
                console.log(
                    `Canvas resized to ${overlay.width}x${overlay.height}`,
                );
            }

            // Draw annotations from detection data
            function drawAnnotations(data) {
                console.log("Received detection data:", JSON.stringify(data));
                ctx.clearRect(0, 0, overlay.width, overlay.height);

                if (data.detections) {
                    console.log(
                        `Processing ${data.detections.length} detections`,
                    );
                    data.detections.forEach((det, index) => {
                        const [x, y, width, height] = det.box;
                        const label = det.label;
                        const color = colorMap[label] || "red";

                        console.log(
                            `Detection ${index}: x=${x}, y=${y}, w=${width}, h=${height}, label=${label}, color=${color}`,
                        );

                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y, width, height);
                        ctx.fillStyle = color;
                        ctx.font = "16px Arial";
                        ctx.fillText(label, x, y - 5);
                    });
                } else {
                    console.warn("No valid detections in response");
                }
            }

            // Handle image selection and send to server
            imageInput.addEventListener("change", () => {
                if (imageInput.files && imageInput.files[0]) {
                    status.textContent = "Processando imagem...";
                    const file = imageInput.files[0];

                    // Read and display the image
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        image.src = e.target.result;
                        image.style.display = "block";

                        // Wait for image to load before fetching detections
                        image.onload = async () => {
                            resizeCanvas();

                            // Send to server
                            const formData = new FormData();
                            formData.append("image", file);

                            try {
                                const response = await fetch("/detect", {
                                    method: "POST",
                                    body: formData,
                                });
                                if (!response.ok)
                                    throw new Error("Server error");
                                const data = await response.json();
                                drawAnnotations(data);
                                status.textContent = "Imagem processada.";
                            } catch (err) {
                                status.textContent = "Error: " + err.message;
                                console.error("Fetch error:", err);
                            }
                        };
                    };
                    reader.readAsDataURL(file);
                }
            });
        </script>
    </body>
</html>
